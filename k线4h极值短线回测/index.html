<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K线 + 技术指标（Vue3 + Lightweight Charts）</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left {
            width: 320px;
            background: #020617;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #1e293b;
            scrollbar-width: thin;
            scrollbar-color: #334155 #020617;
        }

        .left::-webkit-scrollbar {
            width: 6px;
        }

        .left::-webkit-scrollbar-track {
            background: #020617;
        }

        .left::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 3px;
        }

        .right {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        .panel {
            border: 1px solid #1e293b;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 4px;
            background: rgba(2, 6, 23, 0.8);
        }

        .panel h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #cbd5f5;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e293b;
        }

        label {
            font-size: 12px;
            display: block;
            margin-top: 8px;
            color: #94a3b8;
        }

        input,
        select,
        button {
            width: 100%;
            margin-top: 4px;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* 颜色选择器样式优化 */
        input[type="color"] {
            padding: 2px;
            height: 34px;
            cursor: pointer;
            background: #0f172a;
        }

        /* 透明度输入框样式 */
        .opacity-input {
            width: 100%;
            margin-top: 4px;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* 开关样式 */
        .toggle-switch {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .toggle-switch input {
            width: auto;
            margin-right: 6px;
        }
        
        .toggle-switch label {
            margin: 0;
            display: inline;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #64748b;
        }

        button {
            cursor: pointer;
            background: #1e293b;
            transition: all 0.2s ease;
            border: none;
            margin-top: 8px;
        }

        button:hover {
            background: #334155;
        }

        button:active {
            opacity: 0.8;
        }

        .ema-row {
            border: 1px solid #334155;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            background: #0f172a;
        }

        .small-btn {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 4px 8px;
            margin-top: 10px;
        }

        .small-btn:hover {
            background: #1e293b;
        }

        /* 悬浮提示层样式（微调） */
        .kline-tooltip {
            position: absolute;
            z-index: 100;
            background: #020617;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            color: #e5e7eb;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            min-width: 180px;
            max-width: 220px;
            box-sizing: border-box;
        }

        .kline-tooltip .tooltip-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .kline-tooltip .tooltip-label {
            color: #94a3b8;
        }

        .kline-tooltip .tooltip-value {
            color: #cbd5f5;
        }

        .kline-tooltip .tooltip-up {
            color: #22c55e;
        }

        .kline-tooltip .tooltip-down {
            color: #ef4444;
        }

        @media (max-width: 480px) {
            #app {
                flex-direction: column;
            }

            .left {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #1e293b;
            }

            .right {
                height: 60vh;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- 左侧功能区 -->
        <div class="left">
            <!-- 参数设置 -->
            <div class="panel">
                <h3>参数设置</h3>
                <label>合约 Symbol</label>
                <input v-model="symbol">
                <label>开始时间</label>
                <input type="datetime-local" v-model="startTime">
                <label>结束时间</label>
                <input type="datetime-local" v-model="endTime">
                <label>快速选择日期</label>
                <input type="date" v-model="selectedDate" @change="fillDay">
                <label>K线周期</label>
                <select v-model="interval" @change="handleIntervalChange">
                    <option>1m</option>
                    <option>5m</option>
                    <option>1h</option>
                    <option>4h</option>
                </select>
                <label>时区</label>
                <select v-model="timezone" @change="updateChartTimeFormatter">
                    <option value="UTC">UTC</option>
                    <option value="Asia/Shanghai">上海</option>
                    <option value="America/New_York">纽约</option>
                </select>
                <button @click="loadKlines">请求K线数据</button>
            </div>

            <!-- 凌晨时段高低点设置（支持颜色+透明度自定义） -->
            <div class="panel">
                <h3>凌晨时段(0:00-4:00)高低点设置</h3>
                <div class="toggle-switch">
                    <input type="checkbox" id="showEarlyLevels" v-model="showEarlyLevels" @change="toggleEarlyLevels">
                    <label for="showEarlyLevels">显示高低点线</label>
                </div>
                <label>最高价线段颜色</label>
                <input type="color" v-model="earlyHighColorHex" @change="updateEarlyHighRgba">
                <label>最高价线段透明度 (0-1)</label>
                <input type="number" v-model.number="earlyHighOpacity" min="0" max="1" step="0.1"
                    @change="updateEarlyHighRgba" class="opacity-input">

                <label style="margin-top: 12px;">最低价线段颜色</label>
                <input type="color" v-model="earlyLowColorHex" @change="updateEarlyLowRgba">
                <label>最低价线段透明度 (0-1)</label>
                <input type="number" v-model.number="earlyLowOpacity" min="0" max="1" step="0.1"
                    @change="updateEarlyLowRgba" class="opacity-input">

                <!-- 实时显示高低点数值 -->
                <div v-if="earlyHigh || earlyLow"
                    style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #1e293b;">
                    <div class="tooltip-item">
                        <span class="tooltip-label">最高价格</span>
                        <span class="tooltip-value tooltip-up">{{ earlyHigh?.toFixed(4) }}</span>
                    </div>
                    <div class="tooltip-item">
                        <span class="tooltip-label">最低价格</span>
                        <span class="tooltip-value tooltip-down">{{ earlyLow?.toFixed(4) }}</span>
                    </div>
                </div>
            </div>

            <!-- 技术指标 - EMA（支持颜色+透明度自定义） -->
            <div class="panel">
                <h3>技术指标 - EMA</h3>
                <div v-for="(ema, i) in emas" :key="ema.id" class="ema-row">
                    <div class="toggle-switch">
                        <input type="checkbox" :id="'showEma' + ema.id" v-model="ema.show" @change="updateIndicators">
                        <label :for="'showEma' + ema.id">显示EMA {{ ema.length }}</label>
                    </div>
                    <label>周期</label>
                    <input type="number" v-model.number="ema.length" @input="updateIndicators" min="1">
                    <label>均线颜色</label>
                    <input type="color" v-model="ema.colorHex" @change="updateEmaRgba(ema)">
                    <label>均线透明度 (0-1)</label>
                    <input type="number" v-model.number="ema.opacity" min="0" max="1" step="0.1"
                        @change="updateEmaRgba(ema)" class="opacity-input">
                    <button class="small-btn" @click="removeEma(i)">删除</button>
                </div>
                <button @click="addEma">+ 添加 EMA</button>
            </div>

            <!-- 合约计算器 -->
            <div class="panel">
                <h3>合约计算器</h3>
                <div style="font-size:12px;opacity:.6">
                    后续可加入强平价、盈亏计算等
                </div>
            </div>
        </div>

        <!-- 图表区 -->
        <div class="right" ref="chartEl">
            <div class="kline-tooltip" ref="tooltipEl"
                :style="{ top: tooltipPos.top + 'px', left: tooltipPos.left + 'px', opacity: tooltipPos.opacity }">
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">时间</span>
                    <span class="tooltip-value">{{ formatUtcToSelectedTimezone(currentKline.time) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">开盘</span>
                    <span class="tooltip-value">{{ currentKline.open.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最高</span>
                    <span class="tooltip-value">{{ currentKline.high.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最低</span>
                    <span class="tooltip-value">{{ currentKline.low.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">收盘</span>
                    <span
                        :class="['tooltip-value', currentKline.close >= currentKline.open ? 'tooltip-up' : 'tooltip-down']">
                        {{ currentKline.close.toFixed(4) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    chart: null,
                    candleSeries: null,
                    emaSeries: [],
                    // 凌晨时段高低点线系列
                    earlyHighLine: null,
                    earlyLowLine: null,
                    klines: [],

                    // 核心配置项
                    symbol: 'BTCUSDT',
                    interval: '1m',
                    timezone: 'UTC',
                    startTime: '',
                    endTime: '',
                    selectedDate: '',

                    // 凌晨时段高低点配置（支持16进制颜色+透明度）
                    earlyHigh: null,
                    earlyLow: null,
                    earlyHighColorHex: '#ffd700', // 金色默认
                    earlyHighOpacity: 0.7,
                    earlyHighRgba: 'rgba(255, 215, 0, 0.7)',
                    earlyLowColorHex: '#00ffff', // 青色默认
                    earlyLowOpacity: 0.7,
                    earlyLowRgba: 'rgba(0, 255, 255, 0.7)',
                    showEarlyLevels: true, // 凌晨时段高低点显示开关

                    // EMA配置（每个EMA包含16进制颜色+透明度+RGBA，支持全缓存）
                    emas: [],

                    // 悬浮提示相关数据
                    currentKline: null,
                    tooltipPos: {
                        top: 0,
                        left: 0,
                        opacity: 0
                    }
                }
            },

            mounted() {
                this.initChart();
                this.loadCache(); // 优先加载缓存
                this.setDefaultTodayTime();
                this.updateChartTimeFormatter();
                this.updateIndicators();
                this.initCrosshairListener();

                // 初始化EMA和凌晨时段的RGBA值（从缓存/默认值转换）
                this.emas.forEach(ema => this.updateEmaRgba(ema));
                this.updateEarlyHighRgba();
                this.updateEarlyLowRgba();

                window.addEventListener('resize', this.handleWindowResize);
            },

            unmounted() {
                window.removeEventListener('resize', this.handleWindowResize);
            },

            methods: {
                /**
                 * 格式化时间（转换为用户选择的时区）
                 */
                formatUtcToSelectedTimezone(utcTimestamp) {
                    if (!utcTimestamp) return '';
                    const date = new Date(utcTimestamp * 1000);
                    return new Intl.DateTimeFormat('zh-CN', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }).format(date);
                },

                /**
                 * 更新图表时间格式化器
                 */
                updateChartTimeFormatter() {
                    if (!this.chart) return;
                    this.chart.timeScale().applyOptions({
                        tickMarkFormatter: (utcTimestamp) => this.formatUtcToSelectedTimezone(utcTimestamp)
                    });
                },

                /**
                 * 设置默认当日时间
                 */
                setDefaultTodayTime() {
                    if (this.startTime && this.endTime) return;

                    const now = new Date();
                    const timezoneDateFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const parts = timezoneDateFormatter.formatToParts(now);

                    const year = parts.find(p => p.type === 'year').value;
                    const month = parts.find(p => p.type === 'month').value;
                    const day = parts.find(p => p.type === 'day').value;
                    const todayLocalDate = `${year}-${month}-${day}`;
                    this.selectedDate = this.selectedDate || todayLocalDate;
                    this.startTime = this.startTime || `${todayLocalDate}T00:00`;
                    this.endTime = this.endTime || `${todayLocalDate}T23:59`;
                },

                /**
                 * 初始化图表
                 */
                initChart() {
                    if (!this.$refs.chartEl) return;

                    this.chart = LightweightCharts.createChart(this.$refs.chartEl, {
                        layout: { background: { color: '#020617' }, textColor: '#cbd5f5' },
                        grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                        timeScale: { timeVisible: true, secondsVisible: false },
                        crosshair: {
                            // 禁用水平价格虚线（横贯图表的那条线）
                            horzLine: {
                                // visible: false, // 关键属性：设为 false 隐藏水平价格线
                                // 补充：即使开启，也可配置样式（此处禁用后无需配置）
                                color: '#999',
                                style: LightweightCharts.LineStyle.Dashed,
                            },
                            // 可选：保留垂直时间线（不影响用户查看对应时间）
                            vertLine: {
                                visible: true,
                                color: '#666',
                                style: LightweightCharts.LineStyle.Dashed,
                            },
                        },
                        height: this.$refs.chartEl.clientHeight
                    });

                    this.candleSeries = this.chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: '#22c55e',
                        downColor: '#ef4444',
                        borderUpColor: '#22c55e',
                        borderDownColor: '#ef4444',
                        wickUpColor: '#22c55e',
                        wickDownColor: '#ef4444'
                    });
                },

                /**
                 * 初始化十字光标监听（悬浮提示）
                 */
                initCrosshairListener() {
                    if (!this.chart || !this.candleSeries) return;

                    this.chart.subscribeCrosshairMove((param) => {
                        const point = param.point;
                        if (!point || !param.time) {
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }

                        // 匹配当前K线数据
                        const currentKline = this.klines.find(k => k.time === param.time);
                        if (!currentKline) {
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }
                        this.currentKline = currentKline;

                        // 计算提示框位置（边界处理）
                        const chartRect = this.$refs.chartEl.getBoundingClientRect();
                        const tooltipEl = this.$refs.tooltipEl;
                        const tooltipWidth = tooltipEl.offsetWidth || 180;
                        const tooltipHeight = tooltipEl.offsetHeight || 100;

                        let left = point.x + 10;
                        let top = point.y + 5;

                        const maxLeft = chartRect.width - tooltipWidth - 10;
                        const maxTop = chartRect.height - tooltipHeight - 10;
                        left = Math.min(left, maxLeft);
                        left = Math.max(left, 10);
                        top = Math.min(top, maxTop);
                        top = Math.max(top, 10);

                        // 更新提示框位置
                        this.tooltipPos = {
                            top: top,
                            left: left,
                            opacity: 1
                        };
                    });
                },

                /**
                 * 加载K线数据
                 */
                async loadKlines() {
                    if (!this.symbol || !this.startTime || !this.endTime) {
                        alert('请填写完整的合约Symbol和时间范围！');
                        return;
                    }
                    const url = `http://127.0.0.1:8001/api/klines?symbol=${this.symbol}&interval=${this.interval}&start=${this.startTime}&end=${this.endTime}&timezone=${this.timezone}`;

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`请求失败：${res.status} ${res.statusText}`);
                        const data = await res.json();
                        this.klines = data.map(k => ({
                            time: Math.floor(k.time / 1000),
                            open: +k.open,
                            high: +k.high,
                            low: +k.low,
                            close: +k.close
                        }));

                        this.candleSeries.setData(this.klines);
                        this.chart.timeScale().fitContent();
                        this.updateIndicators();
                        this.calculateAndDrawEarlySessionLevels(); // 计算凌晨高低点
                        this.saveCache(); // 保存最新数据到缓存
                    } catch (error) {
                        console.error('加载K线数据失败：', error);
                        alert('加载K线数据失败，请检查接口是否可用或控制台查看详情！');
                    }
                },

                /**
                 * 转换16进制颜色到RGBA（带透明度）
                 */
                hexToRgba(hex, opacity) {
                    // 去除#号
                    hex = hex.replace(/^#/, '');
                    // 解析RGB值
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);
                    // 返回RGBA格式
                    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
                },

                /**
                 * 更新凌晨时段最高价线段的RGBA值
                 */
                updateEarlyHighRgba() {
                    this.earlyHighRgba = this.hexToRgba(this.earlyHighColorHex, this.earlyHighOpacity);
                    // 实时更新图表线条
                    if (this.earlyHighLine && this.earlyHigh && this.showEarlyLevels) {
                        this.earlyHighLine.applyOptions({ color: this.earlyHighRgba });
                        this.saveCache();
                    }
                },

                /**
                 * 更新凌晨时段最低价线段的RGBA值
                 */
                updateEarlyLowRgba() {
                    this.earlyLowRgba = this.hexToRgba(this.earlyLowColorHex, this.earlyLowOpacity);
                    // 实时更新图表线条
                    if (this.earlyLowLine && this.earlyLow && this.showEarlyLevels) {
                        this.earlyLowLine.applyOptions({ color: this.earlyLowRgba });
                        this.saveCache();
                    }
                },

                /**
                 * 切换凌晨时段高低点显示状态
                 */
                toggleEarlyLevels() {
                    if (this.showEarlyLevels) {
                        this.calculateAndDrawEarlySessionLevels();
                    } else {
                        this.clearEarlySessionLines();
                    }
                },

                /**
                 * 更新单个EMA的RGBA值
                 */
                updateEmaRgba(ema) {
                    ema.color = this.hexToRgba(ema.colorHex, ema.opacity);
                    // 实时更新图表EMA线条
                    this.updateIndicators();
                    this.saveCache();
                },

                /**
                 * 计算并绘制凌晨时段(0:00-4:00)的高低点
                 */
                calculateAndDrawEarlySessionLevels() {
                    // 只在5分钟周期下计算
                    if (this.interval !== '5m' || this.klines.length === 0 || !this.showEarlyLevels) {
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                        return;
                    }

                    // 筛选凌晨0:00-4:00的K线（按用户选择的时区）
                    const earlySessionKlines = [];
                    this.klines.forEach(kline => {
                        const date = new Date(kline.time * 1000);
                        const localTime = new Intl.DateTimeFormat('en-US', {
                            timeZone: this.timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }).format(date);
                        const hour = parseInt(localTime.split(':')[0], 10);
                        if (hour >= 0 && hour < 4) {
                            earlySessionKlines.push(kline);
                        }
                    });

                    if (earlySessionKlines.length === 0) {
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                        return;
                    }

                    // 计算高低价
                    this.earlyHigh = Math.max(...earlySessionKlines.map(k => k.high));
                    this.earlyLow = Math.min(...earlySessionKlines.map(k => k.low));

                    // 绘制高低点线条
                    this.drawEarlySessionLines();
                },

                /**
                 * 绘制凌晨时段高低点水平线
                 */
                drawEarlySessionLines() {
                    if (!this.showEarlyLevels) return;
                    
                    // 清除已有线条
                    this.clearEarlySessionLines();

                    // 创建高点线（自定义颜色+虚线）
                    this.earlyHighLine = this.chart.addSeries(LightweightCharts.LineSeries, {
                        color: this.earlyHighRgba,
                        lineWidth: 1.5,
                        lineStyle: LightweightCharts.LineStyle.Solid,
                        crosshairMarkerVisible: false
                    });

                    // 创建低点线（自定义颜色+虚线）
                    this.earlyLowLine = this.chart.addSeries(LightweightCharts.LineSeries, {
                        color: this.earlyLowRgba,
                        lineWidth: 1.5,
                        lineStyle: LightweightCharts.LineStyle.Solid,
                        crosshairMarkerVisible: false
                    });

                    // 设置线条数据（贯穿整个图表）
                    const highLineData = [
                        { time: this.klines[0].time, value: this.earlyHigh },
                        { time: this.klines[this.klines.length - 1].time, value: this.earlyHigh }
                    ];
                    const lowLineData = [
                        { time: this.klines[0].time, value: this.earlyLow },
                        { time: this.klines[this.klines.length - 1].time, value: this.earlyLow }
                    ];

                    this.earlyHighLine.setData(highLineData);
                    this.earlyLowLine.setData(lowLineData);
                },

                /**
                 * 清除凌晨时段高低点线条
                 */
                clearEarlySessionLines() {
                    if (this.earlyHighLine) {
                        this.chart.removeSeries(this.earlyHighLine);
                        this.earlyHighLine = null;
                    }
                    if (this.earlyLowLine) {
                        this.chart.removeSeries(this.earlyLowLine);
                        this.earlyLowLine = null;
                    }
                },

                /**
                 * 处理K线周期变化
                 */
                handleIntervalChange() {
                    if (this.interval === '5m' && this.klines.length > 0 && this.showEarlyLevels) {
                        this.calculateAndDrawEarlySessionLevels();
                    } else {
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                    }
                    this.saveCache();
                },

                /**
                 * 计算EMA指标
                 */
                calcEMA(data, length) {
                    if (!Array.isArray(data) || data.length === 0 || length < 1) return [];

                    const result = [];
                    const k = 2 / (length + 1);
                    let prevEma = data[0].close;

                    data.forEach(d => {
                        prevEma = d.close * k + prevEma * (1 - k);
                        result.push({ time: d.time, value: prevEma });
                    });

                    return result;
                },

                /**
                 * 更新所有技术指标（EMA）
                 */
                updateIndicators() {
                    if (!this.chart) return;

                    // 清除原有EMA系列
                    this.emaSeries.forEach(s => this.chart.removeSeries(s));
                    this.emaSeries = [];

                    // 重新添加EMA系列（使用自定义颜色+透明度）
                    this.emas.forEach(ema => {
                        if (!ema.length || !ema.color || !ema.show) return;
                        const lineSeries = this.chart.addSeries(LightweightCharts.LineSeries, {
                            color: ema.color,
                            lineWidth: 2
                        });
                        lineSeries.setData(this.calcEMA(this.klines, ema.length));
                        this.emaSeries.push(lineSeries);
                    });

                    // 重新绘制凌晨时段线条（防止被EMA覆盖）
                    if (this.interval === '5m' && this.earlyHigh && this.earlyLow && this.showEarlyLevels) {
                        this.drawEarlySessionLines();
                    }

                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                },

                /**
                 * 添加新的EMA指标（带默认颜色+透明度）
                 */
                addEma() {
                    this.emas.push({
                        id: Date.now(),
                        length: 20,
                        colorHex: '#ffff00', // 黄色默认
                        opacity: 0.8,
                        color: 'rgba(255, 255, 0, 0.8)', // 默认RGBA
                        show: true // 默认显示
                    });
                    this.updateIndicators();
                    this.saveCache();
                },

                /**
                 * 删除指定EMA指标
                 */
                removeEma(i) {
                    this.emas.splice(i, 1);
                    this.updateIndicators();
                    this.saveCache();
                },

                /**
                 * 填充当日时间范围
                 */
                fillDay() {
                    if (!this.selectedDate) return;
                    this.startTime = `${this.selectedDate}T00:00`;
                    this.endTime = `${this.selectedDate}T23:59`;
                    this.saveCache();
                },

                /**
                 * 保存完整缓存（包含所有配置：核心参数、EMA列表、凌晨时段颜色+透明度）
                 */
                saveCache() {
                    try {
                        const cacheData = {
                            // 核心参数
                            symbol: this.symbol,
                            interval: this.interval,
                            timezone: this.timezone,
                            startTime: this.startTime,
                            endTime: this.endTime,
                            selectedDate: this.selectedDate,

                            // 凌晨时段高低点配置（完整保留颜色+透明度）
                            earlyHighColorHex: this.earlyHighColorHex,
                            earlyHighOpacity: this.earlyHighOpacity,
                            earlyLowColorHex: this.earlyLowColorHex,
                            earlyLowOpacity: this.earlyLowOpacity,

                            // EMA列表（完整保留每个EMA的所有属性）
                            emas: this.emas.map(ema => ({
                                id: ema.id,
                                length: ema.length,
                                colorHex: ema.colorHex,
                                opacity: ema.opacity,
                                color: ema.color
                            }))
                        };
                        localStorage.setItem('kline_cfg_complete', JSON.stringify(cacheData));
                    } catch (e) {
                        console.warn('保存缓存失败：', e);
                    }
                },

                /**
                 * 加载完整缓存（恢复所有配置，无丢失）
                 */
                loadCache() {
                    try {
                        const cache = localStorage.getItem('kline_cfg_complete');
                        if (!cache) return;

                        const cacheData = JSON.parse(cache);
                        // 恢复核心参数
                        this.symbol = cacheData.symbol || this.symbol;
                        this.interval = cacheData.interval || this.interval;
                        this.timezone = cacheData.timezone || this.timezone;
                        this.startTime = cacheData.startTime || this.startTime;
                        this.endTime = cacheData.endTime || this.endTime;
                        this.selectedDate = cacheData.selectedDate || this.selectedDate;

                        // 恢复凌晨时段高低点配置
                        this.earlyHighColorHex = cacheData.earlyHighColorHex || this.earlyHighColorHex;
                        this.earlyHighOpacity = cacheData.earlyHighOpacity || this.earlyHighOpacity;
                        this.earlyLowColorHex = cacheData.earlyLowColorHex || this.earlyLowColorHex;
                        this.earlyLowOpacity = cacheData.earlyLowOpacity || this.earlyLowOpacity;

                        // 恢复EMA列表（完整保留每个EMA的属性）
                        this.emas = cacheData.emas && Array.isArray(cacheData.emas)
                            ? cacheData.emas.map(ema => ({
                                id: ema.id || Date.now(),
                                length: ema.length || 20,
                                colorHex: ema.colorHex || '#ffff00',
                                opacity: ema.opacity || 0.8,
                                color: ema.color || 'rgba(255, 255, 0, 0.8)',
                                show: true // 从缓存加载时默认显示
                            }))
                            : [];

                        // 同步更新RGBA值
                        this.updateEarlyHighRgba();
                        this.updateEarlyLowRgba();
                        this.emas.forEach(ema => this.updateEmaRgba(ema));

                    } catch (e) {
                        console.warn('加载缓存失败：', e);
                    }
                },

                /**
                 * 处理窗口大小变化
                 */
                handleWindowResize() {
                    if (!this.chart || !this.$refs.chartEl) return;
                    this.chart.applyOptions({ height: this.$refs.chartEl.clientHeight });
                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                }
            }
        }).mount('#app');
    </script>
</body>

</html>