<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K线 + 技术指标（Vue3 + Lightweight Charts）</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left {
            width: 320px;
            background: #020617;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #1e293b;
            scrollbar-width: thin;
            scrollbar-color: #334155 #020617;
        }

        .left::-webkit-scrollbar {
            width: 6px;
        }

        .left::-webkit-scrollbar-track {
            background: #020617;
        }

        .left::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 3px;
        }

        .right {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        .panel {
            border: 1px solid #1e293b;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 4px;
            background: rgba(2, 6, 23, 0.8);
        }

        .panel h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #cbd5f5;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e293b;
        }

        label {
            font-size: 12px;
            display: block;
            margin-top: 8px;
            color: #94a3b8;
        }

        input,
        select,
        button {
            width: 100%;
            margin-top: 4px;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #64748b;
        }

        button {
            cursor: pointer;
            background: #1e293b;
            transition: all 0.2s ease;
            border: none;
            margin-top: 8px;
        }

        button:hover {
            background: #334155;
        }

        button:active {
            opacity: 0.8;
        }

        .ema-row {
            border: 1px solid #334155;
            padding: 10px;
            margin-top: 8px;
            border-radius: 3px;
            background: #0f172a;
        }

        .small-btn {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 4px 8px;
            margin-top: 10px;
        }

        .small-btn:hover {
            background: #1e293b;
        }

        /* 新增：K线数据悬浮提示层样式 */
        .kline-tooltip {
            position: absolute;
            z-index: 100;
            background: #020617;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            color: #e5e7eb;
            pointer-events: none; /* 防止遮挡光标事件 */
            opacity: 0;
            transition: opacity 0.2s ease;
            min-width: 180px;
        }

        .kline-tooltip .tooltip-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .kline-tooltip .tooltip-label {
            color: #94a3b8;
        }

        .kline-tooltip .tooltip-value {
            color: #cbd5f5;
        }

        .kline-tooltip .tooltip-up {
            color: #22c55e;
        }

        .kline-tooltip .tooltip-down {
            color: #ef4444;
        }

        @media (max-width: 480px) {
            #app {
                flex-direction: column;
            }

            .left {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #1e293b;
            }

            .right {
                height: 60vh;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- 左侧功能区 -->
        <div class="left">
            <!-- 参数设置 -->
            <div class="panel">
                <h3>参数设置</h3>
                <label>合约 Symbol</label>
                <input v-model="symbol">
                <label>开始时间</label>
                <input type="datetime-local" v-model="startTime">
                <label>结束时间</label>
                <input type="datetime-local" v-model="endTime">
                <label>快速选择日期</label>
                <input type="date" v-model="selectedDate" @change="fillDay">
                <label>K线周期</label>
                <select v-model="interval">
                    <option>1m</option>
                    <option>5m</option>
                    <option>1h</option>
                    <option>4h</option>
                </select>
                <label>时区</label>
                <select v-model="timezone" @change="updateChartTimeFormatter">
                    <option value="UTC">UTC</option>
                    <option value="Asia/Shanghai">上海</option>
                    <option value="America/New_York">纽约</option>
                </select>
                <button @click="loadKlines">请求K线数据</button>
            </div>
            <!-- 技术指标 -->
            <div class="panel">
                <h3>技术指标 - EMA</h3>
                <div v-for="(ema, i) in emas" :key="ema.id" class="ema-row">
                    <label>周期</label>
                    <input type="number" v-model.number="ema.length" @input="updateIndicators" min="1">
                    <label>颜色 (rgba)</label>
                    <input v-model="ema.color" @input="updateIndicators" placeholder="例如：rgba(255,255,0,0.8)">
                    <button class="small-btn" @click="removeEma(i)">删除</button>
                </div>
                <button @click="addEma">+ 添加 EMA</button>
            </div>
            <!-- 合约计算器 -->
            <div class="panel">
                <h3>合约计算器</h3>
                <div style="font-size:12px;opacity:.6">
                    后续可加入强平价、盈亏计算等
                </div>
            </div>
        </div>
        <!-- 图表区：新增悬浮提示层 -->
        <div class="right" ref="chartEl">
            <div class="kline-tooltip" ref="tooltipEl" :style="{ top: tooltipPos.top + 'px', left: tooltipPos.left + 'px', opacity: tooltipPos.opacity }">
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">时间</span>
                    <span class="tooltip-value">{{ formatUtcToSelectedTimezone(currentKline.time) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">开盘</span>
                    <span class="tooltip-value">{{ currentKline.open.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最高</span>
                    <span class="tooltip-value">{{ currentKline.high.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最低</span>
                    <span class="tooltip-value">{{ currentKline.low.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">收盘</span>
                    <span :class="['tooltip-value', currentKline.close >= currentKline.open ? 'tooltip-up' : 'tooltip-down']">
                        {{ currentKline.close.toFixed(4) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    chart: null,
                    candleSeries: null,
                    emaSeries: [],
                    klines: [],

                    // 核心配置项
                    symbol: 'BTCUSDT',
                    interval: '1m',
                    timezone: 'UTC',
                    startTime: '',
                    endTime: '',
                    selectedDate: '',
                    emas: [],

                    // 新增：悬浮提示相关数据
                    currentKline: null, // 当前选中的K线数据
                    tooltipPos: { // 提示层位置和透明度
                        top: 0,
                        left: 0,
                        opacity: 0
                    }
                }
            },

            mounted() {
                this.initChart();
                this.loadCache();
                this.setDefaultTodayTime();
                this.updateChartTimeFormatter();
                this.updateIndicators();
                // 新增：初始化十字光标监听
                this.initCrosshairListener();

                // 窗口大小变化监听
                window.addEventListener('resize', this.handleWindowResize);
            },

            unmounted() {
                // 移除窗口监听，防止内存泄漏
                window.removeEventListener('resize', this.handleWindowResize);
            },

            methods: {
                /**
                 * 核心1：图表渲染专用 - 将秒级UTC时间戳转为「选中时区」的本地格式化时间
                 * 保证图表刻度尺显示的是选中时区的时间（如纽约时间26日00:00-23:59）
                 * @param {number} utcTimestamp - 秒级UTC时间戳（Lightweight Charts 传入）
                 * @returns {string} 格式化后的选中时区本地时间字符串
                 */
                formatUtcToSelectedTimezone(utcTimestamp) {
                    if (!utcTimestamp) return '';
                    // 转为毫秒级适配JavaScript Date对象
                    const date = new Date(utcTimestamp * 1000);
                    // 强制使用选中的时区进行格式化，保证显示一致
                    return new Intl.DateTimeFormat('zh-CN', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }).format(date);
                },

                /**
                 * 仅更新图表时间显示格式（切换时区时调用，不改动已有数据和时间轴）
                 * 满足：切换时区后，已有图表时间轴位置不变，仅刻度尺显示为新时区格式
                 */
                updateChartTimeFormatter() {
                    if (!this.chart) return;
                    // 仅更新时间刻度的格式化逻辑，不重新设置K线数据，不改变图表布局
                    this.chart.timeScale().applyOptions({
                        tickMarkFormatter: (utcTimestamp) => this.formatUtcToSelectedTimezone(utcTimestamp)
                    });
                },

                /**
                 * 初始化「选中时区」当天的默认本地时间范围
                 * 保证默认时间也是对应时区的本地时间（如纽约时区的当天00:00-23:59）
                 */
                setDefaultTodayTime() {
                    if (this.startTime && this.endTime) return; // 保留缓存优先级，不覆盖已有值

                    const now = new Date();
                    const timezoneDateFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const parts = timezoneDateFormatter.formatToParts(now);

                    const year = parts.find(p => p.type === 'year').value;
                    const month = parts.find(p => p.type === 'month').value;
                    const day = parts.find(p => p.type === 'day').value;
                    const todayLocalDate = `${year}-${month}-${day}`;
                    // 赋值该时区的本地默认时间范围
                    this.selectedDate = this.selectedDate || todayLocalDate;
                    this.startTime = this.startTime || `${todayLocalDate}T00:00`;
                    this.endTime = this.endTime || `${todayLocalDate}T23:59`;
                },

                /**
                 * 初始化图表
                 */
                initChart() {
                    if (!this.$refs.chartEl) return;

                    this.chart = LightweightCharts.createChart(this.$refs.chartEl, {
                        layout: { background: { color: '#020617' }, textColor: '#cbd5f5' },
                        grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                        timeScale: { timeVisible: true, secondsVisible: false },
                        height: this.$refs.chartEl.clientHeight
                    });

                    this.candleSeries = this.chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: '#22c55e',
                        downColor: '#ef4444',
                        borderUpColor: '#22c55e',
                        borderDownColor: '#ef4444',
                        wickUpColor: '#22c55e',
                        wickDownColor: '#ef4444'
                    });
                },

                /**
                 * 新增：初始化十字光标移动监听，实现K线数据悬浮显示
                 */
                initCrosshairListener() {
                    if (!this.chart || !this.candleSeries) return;

                    // 核心API：subscribeCrosshairMove 监听十字光标移动事件
                    this.chart.subscribeCrosshairMove((param) => {
                        // 1. 从当前光标位置获取K线数据（通过candleSeries的dataAtIndex方法）
                        const point = param.point;
                        if (!point || !param.time) {
                            // 光标离开图表区域，隐藏提示层
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }

                        // 2. 匹配当前时间对应的K线数据
                        const currentKline = this.klines.find(k => k.time === param.time);
                        if (!currentKline) {
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }

                        // 3. 更新当前K线数据
                        this.currentKline = currentKline;

                        // 4. 计算提示层位置（偏移光标位置，防止遮挡）
                        const chartRect = this.$refs.chartEl.getBoundingClientRect();
                        this.tooltipPos = {
                            top: point.y + chartRect.top + 10, // 向下偏移10px
                            left: point.x + chartRect.left + 10, // 向右偏移10px
                            opacity: 1 // 显示提示层
                        };
                    });
                },

                /**
                 * 核心：加载K线数据（准确映射选中时区时间范围→UTC请求→图表渲染选中时区）
                 */
                async loadKlines() {
                    if (!this.symbol || !this.startTime || !this.endTime) {
                        alert('请填写完整的合约Symbol和时间范围！');
                        return;
                    }
                    // 验证转换结果
                    if (!this.startTime || !this.endTime) {
                        alert('时间格式无效，请检查输入！');
                        return;
                    }
                    // 构造接口请求地址（携带UTC时间戳，满足后台要求）
                    const url = `http://127.0.0.1:8001/api/klines?symbol=${this.symbol}&interval=${this.interval}&start=${this.startTime}&end=${this.endTime}&timezone=${this.timezone}`;

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`请求失败：${res.status} ${res.statusText}`);
                        const data = await res.json();
                        // 后台返回UTC毫秒级→转秒级供图表使用
                        this.klines = data.map(k => ({
                            time: Math.floor(k.time / 1000),
                            open: +k.open,
                            high: +k.high,
                            low: +k.low,
                            close: +k.close
                        }));

                        // 仅在请求新数据后，更新图表内容和时间轴（同步选中时区显示格式）
                        this.candleSeries.setData(this.klines);
                        this.chart.timeScale().fitContent(); // 自动适配内容
                        this.updateIndicators(); // 更新EMA指标
                        this.saveCache(); // 保存最新配置
                    } catch (error) {
                        console.error('加载K线数据失败：', error);
                        alert('加载K线数据失败，请检查接口是否可用或控制台查看详情！');
                    }
                },

                /**
                 * 简化：计算EMA指标
                 */
                calcEMA(data, length) {
                    if (!Array.isArray(data) || data.length === 0 || length < 1) return [];

                    const result = [];
                    const k = 2 / (length + 1);
                    let prevEma = data[0].close;

                    data.forEach(d => {
                        prevEma = d.close * k + prevEma * (1 - k);
                        result.push({ time: d.time, value: prevEma });
                    });

                    return result;
                },

                /**
                 * 简化：更新EMA指标系列
                 */
                updateIndicators() {
                    if (!this.chart) return;

                    // 移除旧的EMA系列
                    this.emaSeries.forEach(s => this.chart.removeSeries(s));
                    this.emaSeries = [];

                    this.emas.forEach(ema => {
                        if (!ema.length || !ema.color) return;
                        const lineSeries = this.chart.addSeries(LightweightCharts.LineSeries, {
                            color: ema.color,
                            lineWidth: 2
                        });
                        lineSeries.setData(this.calcEMA(this.klines, ema.length));
                        this.emaSeries.push(lineSeries);
                    });

                    // 适配图表内容
                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                },

                /**
                 * 添加EMA指标
                 */
                addEma() {
                    this.emas.push({
                        id: Date.now(),
                        length: 20,
                        color: 'rgba(255,255,0,0.8)'
                    });
                    this.updateIndicators();
                },

                /**
                 * 删除EMA指标
                 */
                removeEma(i) {
                    this.emas.splice(i, 1);
                    this.updateIndicators();
                },

                /**
                 * 快速填充「选中时区」的当日本地时间范围
                 */
                fillDay() {
                    if (!this.selectedDate) return;
                    this.startTime = `${this.selectedDate}T00:00`;
                    this.endTime = `${this.selectedDate}T23:59`;
                },

                /**
                 * 保存配置缓存到本地存储
                 */
                saveCache() {
                    try {
                        localStorage.setItem('kline_cfg', JSON.stringify({
                            symbol: this.symbol,
                            interval: this.interval,
                            timezone: this.timezone,
                            startTime: this.startTime,
                            endTime: this.endTime,
                            selectedDate: this.selectedDate,
                            emas: this.emas
                        }));
                    } catch (e) {
                        console.warn('保存缓存失败：', e);
                    }
                },

                /**
                 * 从本地存储加载配置缓存
                 */
                loadCache() {
                    try {
                        const cache = localStorage.getItem('kline_cfg');
                        if (cache) Object.assign(this, JSON.parse(cache));
                    } catch (e) {
                        console.warn('加载缓存失败：', e);
                    }
                },

                /**
                 * 窗口大小变化处理
                 */
                handleWindowResize() {
                    if (!this.chart || !this.$refs.chartEl) return;
                    this.chart.applyOptions({ height: this.$refs.chartEl.clientHeight });
                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                }
            }
        }).mount('#app');
    </script>
</body>

</html>