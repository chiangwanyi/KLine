<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K线 + 技术指标（Vue3 + Lightweight Charts）</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left {
            width: 320px;
            background: #020617;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #1e293b;
            scrollbar-width: thin;
            scrollbar-color: #334155 #020617;
        }

        .left::-webkit-scrollbar {
            width: 6px;
        }

        .left::-webkit-scrollbar-track {
            background: #020617;
        }

        .left::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 3px;
        }

        .right {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        .panel {
            border: 1px solid #1e293b;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 4px;
            background: rgba(2, 6, 23, 0.8);
        }

        .panel h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #cbd5f5;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e293b;
        }

        label {
            font-size: 12px;
            display: block;
            margin-top: 8px;
            color: #94a3b8;
        }

        input,
        select,
        button {
            width: 100%;
            margin-top: 4px;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #64748b;
        }

        button {
            cursor: pointer;
            background: #1e293b;
            transition: all 0.2s ease;
            border: none;
            margin-top: 8px;
        }

        button:hover {
            background: #334155;
        }

        button:active {
            opacity: 0.8;
        }

        .ema-row {
            border: 1px solid #334155;
            padding: 10px;
            margin-top: 8px;
            border-radius: 3px;
            background: #0f172a;
        }

        .small-btn {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 4px 8px;
            margin-top: 10px;
        }

        .small-btn:hover {
            background: #1e293b;
        }

        /* 悬浮提示层样式（微调） */
        .kline-tooltip {
            position: absolute;
            z-index: 100;
            background: #020617;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            color: #e5e7eb;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            min-width: 180px;
            max-width: 220px;
            box-sizing: border-box;
        }

        .kline-tooltip .tooltip-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .kline-tooltip .tooltip-label {
            color: #94a3b8;
        }

        .kline-tooltip .tooltip-value {
            color: #cbd5f5;
        }

        .kline-tooltip .tooltip-up {
            color: #22c55e;
        }

        .kline-tooltip .tooltip-down {
            color: #ef4444;
        }

        @media (max-width: 480px) {
            #app {
                flex-direction: column;
            }

            .left {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #1e293b;
            }

            .right {
                height: 60vh;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- 左侧功能区 -->
        <div class="left">
            <!-- 参数设置 -->
            <div class="panel">
                <h3>参数设置</h3>
                <label>合约 Symbol</label>
                <input v-model="symbol">
                <label>开始时间</label>
                <input type="datetime-local" v-model="startTime">
                <label>结束时间</label>
                <input type="datetime-local" v-model="endTime">
                <label>快速选择日期</label>
                <input type="date" v-model="selectedDate" @change="fillDay">
                <label>K线周期</label>
                <select v-model="interval" @change="handleIntervalChange">
                    <option>1m</option>
                    <option>5m</option>
                    <option>1h</option>
                    <option>4h</option>
                </select>
                <label>时区</label>
                <select v-model="timezone" @change="updateChartTimeFormatter">
                    <option value="UTC">UTC</option>
                    <option value="Asia/Shanghai">上海</option>
                    <option value="America/New_York">纽约</option>
                </select>
                <button @click="loadKlines">请求K线数据</button>
            </div>
            <!-- 技术指标 -->
            <div class="panel">
                <h3>技术指标 - EMA</h3>
                <div v-for="(ema, i) in emas" :key="ema.id" class="ema-row">
                    <label>周期</label>
                    <input type="number" v-model.number="ema.length" @input="updateIndicators" min="1">
                    <label>颜色 (rgba)</label>
                    <input v-model="ema.color" @input="updateIndicators" placeholder="例如：rgba(255,255,0,0.8)">
                    <button class="small-btn" @click="removeEma(i)">删除</button>
                </div>
                <button @click="addEma">+ 添加 EMA</button>
            </div>
            <!-- 凌晨时段高低点 -->
            <div class="panel" v-if="interval === '5m' && (earlyHigh || earlyLow)">
                <h3>凌晨时段(0:00-4:00)高低点</h3>
                <div class="tooltip-item">
                    <span class="tooltip-label">最高价格</span>
                    <span class="tooltip-value tooltip-up">{{ earlyHigh?.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item">
                    <span class="tooltip-label">最低价格</span>
                    <span class="tooltip-value tooltip-down">{{ earlyLow?.toFixed(4) }}</span>
                </div>
            </div>
            <!-- 合约计算器 -->
            <div class="panel">
                <h3>合约计算器</h3>
                <div style="font-size:12px;opacity:.6">
                    后续可加入强平价、盈亏计算等
                </div>
            </div>
        </div>
        <!-- 图表区 -->
        <div class="right" ref="chartEl">
            <div class="kline-tooltip" ref="tooltipEl"
                :style="{ top: tooltipPos.top + 'px', left: tooltipPos.left + 'px', opacity: tooltipPos.opacity }">
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">时间</span>
                    <span class="tooltip-value">{{ formatUtcToSelectedTimezone(currentKline.time) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">开盘</span>
                    <span class="tooltip-value">{{ currentKline.open.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最高</span>
                    <span class="tooltip-value">{{ currentKline.high.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">最低</span>
                    <span class="tooltip-value">{{ currentKline.low.toFixed(4) }}</span>
                </div>
                <div class="tooltip-item" v-if="currentKline">
                    <span class="tooltip-label">收盘</span>
                    <span
                        :class="['tooltip-value', currentKline.close >= currentKline.open ? 'tooltip-up' : 'tooltip-down']">
                        {{ currentKline.close.toFixed(4) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    chart: null,
                    candleSeries: null,
                    emaSeries: [],
                    // 新增：凌晨时段高低点线系列
                    earlyHighLine: null,
                    earlyLowLine: null,
                    klines: [],

                    // 核心配置项
                    symbol: 'BTCUSDT',
                    interval: '1m',
                    timezone: 'UTC',
                    startTime: '',
                    endTime: '',
                    selectedDate: '',
                    emas: [],

                    // 新增：凌晨时段高低点数据
                    earlyHigh: null,
                    earlyLow: null,
                    earlySessionStart: null,
                    earlySessionEnd: null,

                    // 悬浮提示相关数据
                    currentKline: null,
                    tooltipPos: {
                        top: 0,
                        left: 0,
                        opacity: 0
                    }
                }
            },

            mounted() {
                this.initChart();
                this.loadCache();
                this.setDefaultTodayTime();
                this.updateChartTimeFormatter();
                this.updateIndicators();
                this.initCrosshairListener();

                window.addEventListener('resize', this.handleWindowResize);
            },

            unmounted() {
                window.removeEventListener('resize', this.handleWindowResize);
            },

            methods: {
                /**
                 * 格式化时间
                 */
                formatUtcToSelectedTimezone(utcTimestamp) {
                    if (!utcTimestamp) return '';
                    const date = new Date(utcTimestamp * 1000);
                    return new Intl.DateTimeFormat('zh-CN', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }).format(date);
                },

                /**
                 * 更新时间格式化
                 */
                updateChartTimeFormatter() {
                    if (!this.chart) return;
                    this.chart.timeScale().applyOptions({
                        tickMarkFormatter: (utcTimestamp) => this.formatUtcToSelectedTimezone(utcTimestamp)
                    });
                },

                /**
                 * 设置默认时间
                 */
                setDefaultTodayTime() {
                    if (this.startTime && this.endTime) return;

                    const now = new Date();
                    const timezoneDateFormatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const parts = timezoneDateFormatter.formatToParts(now);

                    const year = parts.find(p => p.type === 'year').value;
                    const month = parts.find(p => p.type === 'month').value;
                    const day = parts.find(p => p.type === 'day').value;
                    const todayLocalDate = `${year}-${month}-${day}`;
                    this.selectedDate = this.selectedDate || todayLocalDate;
                    this.startTime = this.startTime || `${todayLocalDate}T00:00`;
                    this.endTime = this.endTime || `${todayLocalDate}T23:59`;
                },

                /**
                 * 初始化图表
                 */
                initChart() {
                    if (!this.$refs.chartEl) return;

                    this.chart = LightweightCharts.createChart(this.$refs.chartEl, {
                        layout: { background: { color: '#020617' }, textColor: '#cbd5f5' },
                        grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                        timeScale: { timeVisible: true, secondsVisible: false },
                        height: this.$refs.chartEl.clientHeight
                    });

                    this.candleSeries = this.chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: '#22c55e',
                        downColor: '#ef4444',
                        borderUpColor: '#22c55e',
                        borderDownColor: '#ef4444',
                        wickUpColor: '#22c55e',
                        wickDownColor: '#ef4444'
                    });
                },

                /**
                 * 初始化十字光标监听
                 */
                initCrosshairListener() {
                    if (!this.chart || !this.candleSeries) return;

                    this.chart.subscribeCrosshairMove((param) => {
                        const point = param.point;
                        if (!point || !param.time) {
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }

                        // 匹配当前K线数据
                        const currentKline = this.klines.find(k => k.time === param.time);
                        if (!currentKline) {
                            this.currentKline = null;
                            this.tooltipPos.opacity = 0;
                            return;
                        }
                        this.currentKline = currentKline;

                        // 计算提示框位置
                        const chartRect = this.$refs.chartEl.getBoundingClientRect();
                        const tooltipEl = this.$refs.tooltipEl;
                        const tooltipWidth = tooltipEl.offsetWidth || 180;
                        const tooltipHeight = tooltipEl.offsetHeight || 100;

                        // 光标右侧偏移10px，下方偏移5px
                        let left = point.x + 10;
                        let top = point.y + 5;

                        // 边界处理
                        const maxLeft = chartRect.width - tooltipWidth - 10;
                        const maxTop = chartRect.height - tooltipHeight - 10;
                        left = Math.min(left, maxLeft);
                        left = Math.max(left, 10);
                        top = Math.min(top, maxTop);
                        top = Math.max(top, 10);

                        // 更新位置
                        this.tooltipPos = {
                            top: top,
                            left: left,
                            opacity: 1
                        };
                    });
                },

                /**
                 * 加载K线数据
                 */
                async loadKlines() {
                    if (!this.symbol || !this.startTime || !this.endTime) {
                        alert('请填写完整的合约Symbol和时间范围！');
                        return;
                    }
                    const url = `http://127.0.0.1:8001/api/klines?symbol=${this.symbol}&interval=${this.interval}&start=${this.startTime}&end=${this.endTime}&timezone=${this.timezone}`;

                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`请求失败：${res.status} ${res.statusText}`);
                        const data = await res.json();
                        this.klines = data.map(k => ({
                            time: Math.floor(k.time / 1000),
                            open: +k.open,
                            high: +k.high,
                            low: +k.low,
                            close: +k.close
                        }));

                        this.candleSeries.setData(this.klines);
                        this.chart.timeScale().fitContent();
                        this.updateIndicators();
                        // 新增：计算并绘制凌晨时段高低点
                        this.calculateAndDrawEarlySessionLevels();
                        this.saveCache();
                    } catch (error) {
                        console.error('加载K线数据失败：', error);
                        alert('加载K线数据失败，请检查接口是否可用或控制台查看详情！');
                    }
                },

                /**
                 * 新增：计算并绘制凌晨时段(0:00-4:00)的高低点
                 */
                calculateAndDrawEarlySessionLevels() {
                    // 只在5分钟周期下才计算
                    if (this.interval !== '5m' || this.klines.length === 0) {
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                        return;
                    }

                    // 确定当前数据覆盖的日期范围
                    const firstKlineTime = this.klines[0].time * 1000;
                    const lastKlineTime = this.klines[this.klines.length - 1].time * 1000;
                    
                    // 找出所有在0:00-4:00之间的K线
                    const earlySessionKlines = [];
                    
                    this.klines.forEach(kline => {
                        const date = new Date(kline.time * 1000);
                        // 转换为用户选择的时区
                        const localTime = new Intl.DateTimeFormat('en-US', {
                            timeZone: this.timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }).format(date);
                        
                        const hour = parseInt(localTime.split(':')[0], 10);
                        // 检查是否在0:00-4:00之间
                        if (hour >= 0 && hour < 4) {
                            earlySessionKlines.push(kline);
                        }
                    });

                    if (earlySessionKlines.length === 0) {
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                        return;
                    }

                    // 计算这段时间的最高和最低价
                    this.earlyHigh = Math.max(...earlySessionKlines.map(k => k.high));
                    this.earlyLow = Math.min(...earlySessionKlines.map(k => k.low));
                    
                    // 记录时段的起止时间
                    this.earlySessionStart = Math.min(...earlySessionKlines.map(k => k.time));
                    this.earlySessionEnd = Math.max(...earlySessionKlines.map(k => k.time));

                    // 绘制水平线
                    this.drawEarlySessionLines();
                },

                /**
                 * 新增：绘制凌晨时段高低点水平线
                 */
                drawEarlySessionLines() {
                    // 清除已有线条
                    this.clearEarlySessionLines();

                    // 创建高点线（黄色虚线）
                    this.earlyHighLine = this.chart.addSeries(LightweightCharts.LineSeries, {
                        color: 'rgba(255, 215, 0, 0.7)',  // 金色
                        lineWidth: 1.5,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false
                    });

                    // 创建低点线（青色虚线）
                    this.earlyLowLine = this.chart.addSeries(LightweightCharts.LineSeries, {
                        color: 'rgba(0, 255, 255, 0.7)',  // 青色
                        lineWidth: 1.5,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        crosshairMarkerVisible: false
                    });

                    // 为高点线和低点线设置数据（在整个图表范围内显示）
                    const highLineData = [
                        { time: this.klines[0].time, value: this.earlyHigh },
                        { time: this.klines[this.klines.length - 1].time, value: this.earlyHigh }
                    ];

                    const lowLineData = [
                        { time: this.klines[0].time, value: this.earlyLow },
                        { time: this.klines[this.klines.length - 1].time, value: this.earlyLow }
                    ];

                    this.earlyHighLine.setData(highLineData);
                    this.earlyLowLine.setData(lowLineData);
                },

                /**
                 * 新增：清除凌晨时段高低点线条
                 */
                clearEarlySessionLines() {
                    if (this.earlyHighLine) {
                        this.chart.removeSeries(this.earlyHighLine);
                        this.earlyHighLine = null;
                    }
                    if (this.earlyLowLine) {
                        this.chart.removeSeries(this.earlyLowLine);
                        this.earlyLowLine = null;
                    }
                },

                /**
                 * 新增：处理周期变化
                 */
                handleIntervalChange() {
                    // 当切换到5分钟周期时，重新计算高低点
                    if (this.interval === '5m' && this.klines.length > 0) {
                        this.calculateAndDrawEarlySessionLevels();
                    } else {
                        // 其他周期清除线条
                        this.clearEarlySessionLines();
                        this.earlyHigh = null;
                        this.earlyLow = null;
                    }
                },

                /**
                 * 计算EMA
                 */
                calcEMA(data, length) {
                    if (!Array.isArray(data) || data.length === 0 || length < 1) return [];

                    const result = [];
                    const k = 2 / (length + 1);
                    let prevEma = data[0].close;

                    data.forEach(d => {
                        prevEma = d.close * k + prevEma * (1 - k);
                        result.push({ time: d.time, value: prevEma });
                    });

                    return result;
                },

                /**
                 * 更新指标
                 */
                updateIndicators() {
                    if (!this.chart) return;

                    this.emaSeries.forEach(s => this.chart.removeSeries(s));
                    this.emaSeries = [];

                    this.emas.forEach(ema => {
                        if (!ema.length || !ema.color) return;
                        const lineSeries = this.chart.addSeries(LightweightCharts.LineSeries, {
                            color: ema.color,
                            lineWidth: 2
                        });
                        lineSeries.setData(this.calcEMA(this.klines, ema.length));
                        this.emaSeries.push(lineSeries);
                    });

                    // 重新绘制凌晨时段线条（防止被EMA线条覆盖）
                    if (this.interval === '5m' && this.earlyHigh && this.earlyLow) {
                        this.drawEarlySessionLines();
                    }

                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                },

                /**
                 * 添加EMA
                 */
                addEma() {
                    this.emas.push({
                        id: Date.now(),
                        length: 20,
                        color: 'rgba(255,255,0,0.8)'
                    });
                    this.updateIndicators();
                },

                /**
                 * 删除EMA
                 */
                removeEma(i) {
                    this.emas.splice(i, 1);
                    this.updateIndicators();
                },

                /**
                 * 填充当日时间
                 */
                fillDay() {
                    if (!this.selectedDate) return;
                    this.startTime = `${this.selectedDate}T00:00`;
                    this.endTime = `${this.selectedDate}T23:59`;
                },

                /**
                 * 保存缓存
                 */
                saveCache() {
                    try {
                        localStorage.setItem('kline_cfg', JSON.stringify({
                            symbol: this.symbol,
                            interval: this.interval,
                            timezone: this.timezone,
                            startTime: this.startTime,
                            endTime: this.endTime,
                            selectedDate: this.selectedDate,
                            emas: this.emas
                        }));
                    } catch (e) {
                        console.warn('保存缓存失败：', e);
                    }
                },

                /**
                 * 加载缓存
                 */
                loadCache() {
                    try {
                        const cache = localStorage.getItem('kline_cfg');
                        if (cache) Object.assign(this, JSON.parse(cache));
                    } catch (e) {
                        console.warn('加载缓存失败：', e);
                    }
                },

                /**
                 * 窗口大小变化
                 */
                handleWindowResize() {
                    if (!this.chart || !this.$refs.chartEl) return;
                    this.chart.applyOptions({ height: this.$refs.chartEl.clientHeight });
                    if (this.klines.length > 0) this.chart.timeScale().fitContent();
                }
            }
        }).mount('#app');
    </script>
</body>

</html>