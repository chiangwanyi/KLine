<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K线 + 技术指标（Vue3 + Lightweight Charts）</title>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }

        #app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .left {
            width: 320px;
            background: #020617;
            padding: 10px;
            overflow-y: auto;
            border-right: 1px solid #1e293b;
            scrollbar-width: thin;
            scrollbar-color: #334155 #020617;
        }

        .left::-webkit-scrollbar {
            width: 6px;
        }

        .left::-webkit-scrollbar-track {
            background: #020617;
        }

        .left::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 3px;
        }

        .right {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        .panel {
            border: 1px solid #1e293b;
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 4px;
            background: rgba(2, 6, 23, 0.8);
        }

        .panel h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #cbd5f5;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e293b;
        }

        label {
            font-size: 12px;
            display: block;
            margin-top: 8px;
            color: #94a3b8;
        }

        input,
        select,
        button {
            width: 100%;
            margin-top: 4px;
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 3px;
            font-size: 12px;
            transition: border-color 0.2s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #64748b;
        }

        button {
            cursor: pointer;
            background: #1e293b;
            transition: all 0.2s ease;
            border: none;
            margin-top: 8px;
        }

        button:hover {
            background: #334155;
        }

        button:active {
            opacity: 0.8;
        }

        .ema-row {
            border: 1px solid #334155;
            padding: 10px;
            margin-top: 8px;
            border-radius: 3px;
            background: #0f172a;
        }

        .small-btn {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 4px 8px;
            margin-top: 10px;
        }

        .small-btn:hover {
            background: #1e293b;
        }

        @media (max-width: 480px) {
            #app {
                flex-direction: column;
            }

            .left {
                width: 100%;
                height: 40vh; /* 修复笔误：xian40vh → 40vh */
                border-right: none;
                border-bottom: 1px solid #1e293b;
            }

            .right {
                height: 60vh;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- 左侧功能区 -->
        <div class="left">
            <!-- 参数设置 -->
            <div class="panel">
                <h3>参数设置</h3>
                <label>合约 Symbol</label>
                <input v-model="symbol">
                <label>开始时间</label>
                <input type="datetime-local" v-model="startTime">
                <label>结束时间</label>
                <input type="datetime-local" v-model="endTime">
                <label>快速选择日期</label>
                <input type="date" v-model="selectedDate" @change="fillDay">
                <label>K线周期</label>
                <select v-model="interval">
                    <option>1m</option>
                    <option>5m</option>
                    <option>1h</option>
                    <option>4h</option>
                </select>
                <label>时区</label>
                <select v-model="timezone" @change="updateChartTimeFormatter">
                    <option value="UTC">UTC</option>
                    <option value="Asia/Shanghai">上海</option>
                    <option value="America/New_York">纽约</option>
                </select>
                <button @click="loadKlines">请求K线数据</button>
            </div>
            <!-- 技术指标 -->
            <div class="panel">
                <h3>技术指标 - EMA</h3>
                <div v-for="(ema, i) in emas" :key="ema.id" class="ema-row">
                    <label>周期</label>
                    <input type="number" v-model.number="ema.length" @input="updateIndicators" min="1">
                    <label>颜色 (rgba)</label>
                    <input v-model="ema.color" @input="updateIndicators" placeholder="例如：rgba(255,255,0,0.8)">
                    <button class="small-btn" @click="removeEma(i)">删除</button>
                </div>
                <button @click="addEma">+ 添加 EMA</button>
            </div>
            <!-- 合约计算器（占位） -->
            <div class="panel">
                <h3>合约计算器</h3>
                <div style="font-size:12px;opacity:.6">
                    后续可加入强平价、盈亏计算等
                </div>
            </div>
        </div>
        <!-- 图表区 -->
        <div class="right" ref="chartEl"></div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    chart: null,
                    candleSeries: null,
                    emaSeries: [],
                    klines: [],

                    symbol: 'BTCUSDT',
                    interval: '1m',
                    timezone: 'UTC',
                    startTime: '',
                    endTime: '',
                    selectedDate: '',
                    emas: []
                }
            },

            mounted() {
                this.initChart()
                this.loadCache()
                this.updateIndicators()
                // 初始化默认时间（基于当前选中时区）
                this.setDefaultTodayTime()
                // 初始化图表时间格式化器
                this.updateChartTimeFormatter()
                
                // 新增：窗口大小变化监听
                window.addEventListener('resize', this.handleWindowResize);
            },

            beforeUnmount() {
                // 新增：销毁窗口监听，防止内存泄漏
                window.removeEventListener('resize', this.handleWindowResize);
            },

            methods: {
                /**
                 * 工具方法：将UTC时间戳（秒级）格式化为选中时区的本地时间
                 * @param {number} utcTimestamp - 秒级UTC时间戳（Lightweight Charts 传入）
                 * @returns {string} 格式化后的本地时间字符串
                 */
                formatTimezoneDate(utcTimestamp) {
                    if (!utcTimestamp) return '';
                    // 转换为毫秒级时间戳（JavaScript Date 要求）
                    const date = new Date(utcTimestamp * 1000);
                    // 利用Intl.DateTimeFormat实现跨时区格式化
                    const formatter = new Intl.DateTimeFormat('zh-CN', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    return formatter.format(date);
                },

                /**
                 * 工具方法：将选中时区的本地时间转换为UTC时间戳（毫秒）
                 * @param {string} localDateTime - 本地时间字符串（格式：YYYY-MM-DDTHH:mm）
                 * @returns {number|null} UTC毫秒级时间戳，失败返回null
                 */
                localTimeToUtcTimestamp(localDateTime) {
                    if (!localDateTime) return null;
                    try {
                        // 拆分日期和时间部分
                        const [datePart, timePart] = localDateTime.split('T');
                        if (!datePart || !timePart) throw new Error('时间格式错误');
                        
                        const [year, month, day] = datePart.split('-').map(Number);
                        const [hour, minute] = timePart.split(':').map(Number);
                        
                        // 利用Intl.DateTimeFormat解析指定时区的时间，转换为UTC时间戳
                        const formatter = new Intl.DateTimeFormat('en-US', {
                            timeZone: this.timezone,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        });
                        
                        const parts = formatter.formatToParts(new Date(year, month - 1, day, hour, minute));
                        const dateObj = new Date(
                            parts.find(p => p.type === 'year').value,
                            parts.find(p => p.type === 'month').value - 1,
                            parts.find(p => p.type === 'day').value,
                            parts.find(p => p.type === 'hour').value,
                            parts.find(p => p.type === 'minute').value,
                            parts.find(p => p.type === 'second')?.value || 0
                        );
                        
                        // 验证日期有效性
                        if (isNaN(dateObj.getTime())) throw new Error('无效日期');
                        
                        // 返回UTC毫秒级时间戳
                        return dateObj.getTime();
                    } catch (error) {
                        console.error('本地时间转UTC失败：', error);
                        return null;
                    }
                },

                /**
                 * 更新图表时间格式化器（时区切换时调用）
                 */
                updateChartTimeFormatter() {
                    if (!this.chart) return;
                    // 自定义timeScale的tickMarkFormatter，同步选中时区
                    this.chart.timeScale().applyOptions({
                        tickMarkFormatter: (utcTimestamp) => {
                            return this.formatTimezoneDate(utcTimestamp);
                        }
                    });
                    // 重新渲染图表，确保时间轴立即更新
                    if (this.klines.length > 0) {
                        this.candleSeries.setData(this.klines);
                        // 时区切换后也保持图表居中
                        this.chart.timeScale().fitContent();
                    }
                },

                // 核心方法 - 设置选中时区今天的默认时间
                setDefaultTodayTime() {
                    // 若已有缓存的时间/日期，直接返回（不覆盖缓存）
                    if (this.startTime && this.endTime && this.selectedDate) return;

                    // 1. 获取选中时区的当前日期
                    const now = new Date();
                    const formatter = new Intl.DateTimeFormat('en-US', {
                        timeZone: this.timezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    const parts = formatter.formatToParts(now);
                    const year = parts.find(p => p.type === 'year').value;
                    const month = parts.find(p => p.type === 'month').value;
                    const day = parts.find(p => p.type === 'day').value;
                    const todayDate = `${year}-${month}-${day}`;

                    // 2. 格式化时间为 YYYY-MM-DDTHH:mm（适配 datetime-local 输入框）
                    const defaultStartTime = `${todayDate}T00:00`;
                    const defaultEndTime = `${todayDate}T23:59`;

                    // 3. 赋值给响应式变量（仅当无值时赋值，保留缓存优先级）
                    if (!this.selectedDate) this.selectedDate = todayDate;
                    if (!this.startTime) this.startTime = defaultStartTime;
                    if (!this.endTime) this.endTime = defaultEndTime;
                },

                initChart() {
                    if (!this.$refs.chartEl) return;

                    this.chart = LightweightCharts.createChart(this.$refs.chartEl, {
                        layout: {
                            background: { color: '#020617' },
                            textColor: '#cbd5f5'
                        },
                        grid: {
                            vertLines: { color: '#1e293b' },
                            horzLines: { color: '#1e293b' }
                        },
                        timeScale: {
                            timeVisible: true,
                            secondsVisible: false,
                            // 预留格式化器接口，后续由updateChartTimeFormatter初始化
                            tickMarkFormatter: () => ''
                        },
                        height: this.$refs.chartEl.clientHeight
                    })

                    this.candleSeries = this.chart.addSeries(
                        LightweightCharts.CandlestickSeries,
                        {
                            upColor: '#22c55e',
                            downColor: '#ef4444',
                            borderUpColor: '#22c55e',
                            borderDownColor: '#ef4444',
                            wickUpColor: '#22c55e',
                            wickDownColor: '#ef4444'
                        }
                    )
                },

                async loadKlines() {
                    if (!this.symbol || !this.startTime || !this.endTime) {
                        alert('请填写完整的合约Symbol和时间范围！');
                        return;
                    }

                    // 关键修改：使用工具方法将选中时区的本地时间转为UTC时间戳
                    const startTs = this.localTimeToUtcTimestamp(this.startTime);
                    const endTs = this.localTimeToUtcTimestamp(this.endTime);

                    // 验证时间转换结果
                    if (!startTs || !endTs) {
                        alert('时间格式无效，请检查输入！');
                        return;
                    }

                    if (startTs > endTs) {
                        alert('开始时间不能晚于结束时间！');
                        return;
                    }

                    const url = `http://127.0.0.1:8001/api/klines`
                        + `?symbol=${this.symbol}`
                        + `&interval=${this.interval}`
                        + `&start=${startTs}`
                        + `&end=${endTs}`;

                    try {
                        const res = await fetch(url);
                        if (!res.ok) {
                            throw new Error(`请求失败：${res.status} ${res.statusText}`);
                        }
                        const data = await res.json();

                        // 控制台打印data文本
                        console.log(JSON.stringify(data));

                        this.klines = data.map(k => ({
                            // 毫秒级时间戳转换为秒级（Lightweight Charts 要求）
                            time: Math.floor(k.time / 1000),
                            // 直接访问对象属性，+ 号确保转为数字类型（兼容字符串格式返回值）
                            open: +k.open,
                            high: +k.high,
                            low: +k.low,
                            close: +k.close
                        }));

                        // 1. 渲染K线数据
                        this.candleSeries.setData(this.klines);
                        // 2. 关键修复：调用fitContent()让图表数据自动居中、完整显示
                        this.chart.timeScale().fitContent();
                        // 3. 更新技术指标
                        this.updateIndicators();
                        this.saveCache();
                    } catch (error) {
                        console.error('加载K线数据失败：', error);
                        alert('加载K线数据失败，请检查接口是否可用或控制台查看详情！');
                    }
                },

                calcEMA(data, length) {
                    if (!Array.isArray(data) || data.length === 0 || !length || length < 1) {
                        return [];
                    }

                    const result = [];
                    const k = 2 / (length + 1);
                    let prev;

                    data.forEach((d, i) => {
                        if (i === 0) {
                            prev = d.close;
                        } else {
                            prev = d.close * k + prev * (1 - k);
                        }
                        result.push({ time: d.time, value: prev });
                    });
                    return result;
                },

                updateIndicators() {
                    if (!this.chart) return;

                    this.emaSeries.forEach(s => {
                        try {
                            this.chart.removeSeries(s);
                        } catch (e) {
                            console.warn('移除EMA系列失败：', e);
                        }
                    });
                    this.emaSeries = [];

                    this.emas.forEach(e => {
                        if (!e.length || !e.color) return;
                        const s = this.chart.addSeries(
                            LightweightCharts.LineSeries,
                            {
                                color: e.color,
                                lineWidth: 2
                            }
                        );
                        s.setData(this.calcEMA(this.klines, e.length));
                        this.emaSeries.push(s);
                    });

                    // 优化：指标更新后也保持图表居中
                    if (this.klines.length > 0) {
                        this.chart.timeScale().fitContent();
                    }

                    this.saveCache();
                },

                addEma() {
                    this.emas.push({
                        id: Date.now(),
                        length: 20,
                        color: 'rgba(255,255,0,0.8)'
                    });
                    this.updateIndicators();
                },

                removeEma(i) {
                    this.emas.splice(i, 1);
                    this.updateIndicators();
                },

                fillDay() {
                    if (!this.selectedDate) return;
                    this.startTime = `${this.selectedDate}T00:00`;
                    this.endTime = `${this.selectedDate}T23:59`;
                },

                saveCache() {
                    try {
                        localStorage.setItem('kline_cfg', JSON.stringify({
                            symbol: this.symbol,
                            interval: this.interval,
                            timezone: this.timezone,
                            startTime: this.startTime,
                            endTime: this.endTime,
                            selectedDate: this.selectedDate,
                            emas: this.emas
                        }));
                    } catch (e) {
                        console.warn('保存缓存失败：', e);
                    }
                },

                loadCache() {
                    try {
                        const c = localStorage.getItem('kline_cfg');
                        if (!c) return;
                        const v = JSON.parse(c);
                        Object.assign(this, v);
                    } catch (e) {
                        console.warn('加载缓存失败：', e);
                    }
                },

                // 新增：窗口大小变化处理方法
                handleWindowResize() {
                    if (!this.chart || !this.$refs.chartEl) return;
                    // 更新图表高度
                    this.chart.applyOptions({
                        height: this.$refs.chartEl.clientHeight
                    });
                    // 保持图表内容居中
                    if (this.klines.length > 0) {
                        this.chart.timeScale().fitContent();
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>