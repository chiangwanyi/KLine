<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TradingView Style Chart</title>
  <script src="https://unpkg.com/vue@3"></script>
  <!-- 引入Tailwind CSS美化UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome图标 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- 自定义Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E293B',
            secondary: '#334155',
            accent: '#0EA5E9',
            dark: '#0b0e11',
            light: '#f8fafc',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .panel-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-accent focus:outline-none;
      }
      .light-mode {
        @apply bg-light text-gray-800;
      }
      .dark-mode {
        @apply bg-dark text-white;
      }
      .light-panel {
        @apply bg-white border border-gray-200;
      }
      .dark-panel {
        @apply bg-primary;
      }
    }
  </style>
</head>
<body :class="isDarkMode ? 'dark-mode' : 'light-mode'">

<div id="app" class="flex h-screen">
  <!-- 控制面板 - 优化UI -->
  <div :class="['w-80 p-6 panel-shadow flex flex-col', isDarkMode ? 'dark-panel' : 'light-panel']">
    <div class="mb-6 flex justify-between items-center">
      <div>
        <h3 class="text-xl font-semibold mb-1 flex items-center" :class="isDarkMode ? 'text-white' : 'text-gray-800'">
          <i class="fa-solid fa-sliders mr-2 text-accent"></i>参数设置
        </h3>
        <div class="w-16 h-1 bg-accent rounded-full"></div>
      </div>
      <!-- 白天/夜晚模式切换按钮 -->
      <button
        @click="toggleTheme"
        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-secondary transition-colors"
        :title="isDarkMode ? '切换到白天模式' : '切换到夜晚模式'"
      >
        <i :class="['fa-solid', isDarkMode ? 'fa-sun' : 'fa-moon']" :style="{color: isDarkMode ? '#fbbf24' : '#3b82f6'}"></i>
      </button>
    </div>

    <!-- 表单分组 -->
    <div class="space-y-5 flex-grow">
      <!-- 周期选择 -->
      <div class="space-y-2">
        <label class="block text-sm font-medium" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">周期</label>
        <select v-model="interval"
                class="w-full rounded-lg px-3 py-2 input-focus transition-colors"
                :class="isDarkMode ? 'bg-secondary border border-gray-600 text-white' : 'bg-white border border-gray-200 text-gray-800'">
          <option>5m</option>
          <option>1h</option>
          <option>4h</option>
        </select>
      </div>

      <!-- 时区选择 -->
      <div class="space-y-2">
        <label class="block text-sm font-medium" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">时区</label>
        <select v-model="timezone"
                class="w-full rounded-lg px-3 py-2 input-focus transition-colors"
                :class="isDarkMode ? 'bg-secondary border border-gray-600 text-white' : 'bg-white border border-gray-200 text-gray-800'">
          <option value="NY">New York</option>
          <option value="UTC">UTC</option>
          <option value="TOKYO">Tokyo</option>
          <option value="SHANGHAI">Shanghai</option>
        </select>
      </div>

      <!-- 日期选择控件 -->
      <div class="space-y-2">
        <label class="block text-sm font-medium" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">选择日期</label>
        <input type="date"
               v-model="selectedDate"
               class="w-full rounded-lg px-3 py-2 input-focus transition-colors"
               :class="isDarkMode ? 'bg-secondary border border-gray-600 text-white' : 'bg-white border border-gray-200 text-gray-800'"
               @change="updateTimeRange">
      </div>

      <!-- 时间范围展示（只读） -->
      <div class="space-y-2 mt-4">
        <label class="block text-sm font-medium" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">时间范围</label>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">开始时间</label>
            <input v-model="start" readonly
                   class="w-full rounded-lg px-3 py-2 cursor-not-allowed"
                   :class="isDarkMode ? 'bg-secondary/80 border border-gray-600 text-white' : 'bg-gray-100 border border-gray-200 text-gray-800'">
          </div>
          <div>
            <label class="text-xs" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">结束时间</label>
            <input v-model="end" readonly
                   class="w-full rounded-lg px-3 py-2 cursor-not-allowed"
                   :class="isDarkMode ? 'bg-secondary/80 border border-gray-600 text-white' : 'bg-gray-100 border border-gray-200 text-gray-800'">
          </div>
        </div>
      </div>

      <!-- EMA设置区域 -->
      <div class="space-y-4 mt-6 border-t pt-4" :class="isDarkMode ? 'border-gray-600' : 'border-gray-200'">
        <div class="flex justify-between items-center">
          <label class="block text-sm font-medium" :class="isDarkMode ? 'text-gray-300' : 'text-gray-600'">
            <i class="fa-solid fa-chart-line mr-1"></i>EMA指标设置
          </label>
          <button
            @click="addEmaLine"
            class="text-xs px-2 py-1 rounded bg-accent/10 text-accent hover:bg-accent/20 transition-colors"
          >
            <i class="fa-solid fa-plus mr-1"></i>添加EMA线
          </button>
        </div>

        <!-- EMA线列表 -->
        <div v-for="(ema, index) in emaLines" :key="index" class="space-y-2 p-3 rounded" :class="isDarkMode ? 'bg-secondary/50' : 'bg-gray-100'">
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium" :class="isDarkMode ? 'text-gray-200' : 'text-gray-700'">EMA #{{ index + 1 }}</span>
            <button
              @click="removeEmaLine(index)"
              class="text-xs text-red-500 hover:text-red-400 transition-colors"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <!-- EMA长度 -->
            <div>
              <label class="text-xs block mb-1" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">长度</label>
              <input type="number"
                     v-model.number="ema.length"
                     min="1"
                     max="200"
                     class="w-full rounded-lg px-2 py-1 text-sm input-focus transition-colors"
                     :class="isDarkMode ? 'bg-secondary border border-gray-600 text-white' : 'bg-white border border-gray-200 text-gray-800'">
            </div>

            <!-- EMA颜色 -->
            <div>
              <label class="text-xs block mb-1" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">颜色</label>
              <input type="color"
                     v-model="ema.color"
                     class="w-full h-8 rounded-lg cursor-pointer border-0"
                     style="padding: 0;">
            </div>
          </div>

          <!-- EMA透明度 -->
          <div>
            <label class="text-xs block mb-1" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">
              透明度: {{ (ema.opacity * 100).toFixed(0) }}%
            </label>
            <input type="range"
                   v-model="ema.opacity"
                   min="0.1"
                   max="1"
                   step="0.1"
                   class="w-full h-2 rounded-lg appearance-none cursor-pointer"
                   :style="{background: isDarkMode ? '#334155' : '#e5e7eb'}">
          </div>
        </div>

        <!-- 空状态提示 -->
        <div v-if="emaLines.length === 0" class="text-center py-4 text-sm" :class="isDarkMode ? 'text-gray-400' : 'text-gray-500'">
          <i class="fa-solid fa-info-circle mr-1"></i>点击添加按钮创建EMA线
        </div>
      </div>
    </div>

    <!-- 加载按钮 -->
    <button @click="reload"
            class="mt-6 w-full bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
      <i class="fa-solid fa-refresh mr-2"></i>加载数据
    </button>
  </div>

  <!-- 图表区域 -->
  <iframe :src="iframeUrl" class="flex-1 border-0" :style="{background: isDarkMode ? '#0b0e11' : '#f8fafc'}"></iframe>
</div>

<script>
const { createApp } = Vue

// 从localStorage加载保存的配置
const loadFromStorage = () => {
  const saved = localStorage.getItem('chartConfig');
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (e) {
      console.error('加载配置失败', e);
    }
  }

  // 默认配置
  const today = new Date();
  const defaultDate = today.toISOString().split('T')[0];
  return {
    interval: "5m",
    timezone: "SHANGHAI",
    selectedDate: defaultDate,
    start: `${defaultDate} 00:00:00`,
    end: `${defaultDate} 23:59:59`,
    isDarkMode: true,
    emaLines: [
      { length: 20, color: '#0000ff', opacity: 1.0 }, // 默认20周期EMA，蓝色，不透明
    ]
  };
};

// 保存配置到localStorage
const saveToStorage = (config) => {
  try {
    localStorage.setItem('chartConfig', JSON.stringify(config));
  } catch (e) {
    console.error('保存配置失败', e);
  }
};

createApp({
  data() {
    const config = loadFromStorage();

    return {
      interval: config.interval,
      timezone: config.timezone,
      selectedDate: config.selectedDate,
      start: config.start,
      end: config.end,
      isDarkMode: config.isDarkMode ?? true,
      emaLines: config.emaLines ?? [],
      iframeUrl: ""
    }
  },
  watch: {
    // 监听配置变化，自动保存到本地缓存
    interval: { handler: 'saveConfig', deep: false },
    timezone: { handler: 'saveConfig', deep: false },
    selectedDate: { handler: 'saveConfig', deep: false },
    start: { handler: 'saveConfig', deep: false },
    end: { handler: 'saveConfig', deep: false },
    isDarkMode: { handler: 'saveConfig', deep: false },
    emaLines: { handler: 'saveConfig', deep: true }
  },
  methods: {
    // 保存配置到本地缓存
    saveConfig() {
      const config = {
        interval: this.interval,
        timezone: this.timezone,
        selectedDate: this.selectedDate,
        start: this.start,
        end: this.end,
        isDarkMode: this.isDarkMode,
        emaLines: [...this.emaLines]
      };
      saveToStorage(config);
    },

    // 切换白天/夜晚模式
    toggleTheme() {
      this.isDarkMode = !this.isDarkMode;
      // 重新加载图表以应用主题
      this.reload();
    },

    // 添加新的EMA线
    addEmaLine() {
      this.emaLines.push({
        length: 50,  // 默认50周期
        color: '#ff0000',  // 默认红色
        opacity: 1.0  // 默认不透明
      });
    },

    // 删除指定索引的EMA线
    removeEmaLine(index) {
      this.emaLines.splice(index, 1);
    },

    // 根据选择的日期更新时间范围
    updateTimeRange() {
      if (this.selectedDate) {
        this.start = `${this.selectedDate} 00:00:00`;
        this.end = `${this.selectedDate} 23:59:59`;
      }
    },

    // 重新加载图表数据
    reload() {
      const q = new URLSearchParams({
        interval: this.interval,
        timezone: this.timezone,
        start: this.start,
        end: this.end,
        isDarkMode: this.isDarkMode,
        // 将EMA配置转为JSON字符串传递
        emaConfig: JSON.stringify(this.emaLines)
      });
      console.log('请求参数:', q.toString());
      this.iframeUrl = `http://127.0.0.1:8001/chart?${q.toString()}`;
    }
  },
  mounted() {
    // 初始化时加载数据
    this.reload();

    // 监听主题变化，同步iframe的背景色
    setInterval(() => {
      try {
        const iframe = document.querySelector('iframe');
        if (iframe) {
          iframe.style.background = this.isDarkMode ? '#0b0e11' : '#f8fafc';
        }
      } catch (e) {}
    }, 1000);
  }
}).mount("#app")
</script>

</body>
</html>